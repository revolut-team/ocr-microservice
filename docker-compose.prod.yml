version: '3.8'

# OCR Microservice - Produccion (standalone, reutilizable por cualquier proyecto)
# Uso: docker-compose -f docker-compose.prod.yml up -d
# Variables requeridas en .env.prod (no commitear)

services:
  ocr-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ocr-service
    restart: always
    ports:
      - "127.0.0.1:${PORT:-8080}:8080"
    env_file:
      - .env.prod
    environment:
      - OCR_LANG=${OCR_LANG:-es}
      - OCR_USE_GPU=${OCR_USE_GPU:-false}
      - OCR_DET_THRESHOLD=${OCR_DET_THRESHOLD:-0.3}
      - OCR_MIN_CONFIDENCE=${OCR_MIN_CONFIDENCE:-0.7}
      - MAX_IMAGE_SIZE_MB=${MAX_IMAGE_SIZE_MB:-10}
      - PREPROCESSING_PIPELINE=${PREPROCESSING_PIPELINE:-resize,exif_fix,grayscale,denoise,clahe,adaptive_threshold,sharpen}
      - PORT=${PORT:-8080}
      - WORKERS=${WORKERS:-4}
      - LOG_LEVEL=${LOG_LEVEL:-warning}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash}
    volumes:
      - paddleocr-cache:/root/.paddleocr
    networks:
      - ocr-network
    mem_limit: 2g
    mem_reservation: 1g
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.seguramiga.service=ocr"
      - "com.seguramiga.version=1.0.0"
      - "com.seguramiga.env=production"

volumes:
  paddleocr-cache:
    driver: local

networks:
  ocr-network:
    driver: bridge
